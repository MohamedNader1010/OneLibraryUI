"use strict";(self.webpackChunkOneLibraryUI=self.webpackChunkOneLibraryUI||[]).push([[335],{6335:(R,f,a)=>{a.r(f),a.d(f,{NoteFormDialogComponent:()=>d});var T=a(5861),l=a(4006),C=a(8675),Z=a(4128),F=a(4004),A=a(4482),P=a(5403),g=a(5412),S=a(5285),e=a(4650),D=a(4467),x=a(7185),_=a(9648),U=a(8653),J=a(7843),O=a(1809),q=a(9383),b=a(6895),Q=a(5810),y=a(9549),V=a(7392),Y=a(4144),E=a(4385),w=a(3238),I=a(4859);function G(r,t){1&r&&(e.TgZ(0,"h2",28),e._uU(1,"\u062a\u0639\u062f\u064a\u0644 \u0627\u0644\u0645\u0630\u0643\u0631\u0629"),e.qZA())}function W(r,t){1&r&&(e.TgZ(0,"h2",28),e._uU(1,"\u0645\u0630\u0643\u0631\u0629 \u062c\u062f\u064a\u062f\u0629"),e.qZA())}function K(r,t){if(1&r&&(e.TgZ(0,"mat-option",29),e._uU(1),e.qZA()),2&r){const i=t.$implicit;e.Q6J("value",i.id),e.xp6(1),e.Oqu(i.name)}}function L(r,t){if(1&r&&(e.TgZ(0,"mat-option",29),e._uU(1),e.qZA()),2&r){const i=t.$implicit;e.Q6J("value",i.id),e.xp6(1),e.Oqu(i.name)}}function M(r,t){if(1&r&&(e.TgZ(0,"mat-option",29),e._uU(1),e.qZA()),2&r){const i=t.$implicit;e.Q6J("value",i.id),e.xp6(1),e.Oqu(i.name)}}function $(r,t){if(1&r&&(e.TgZ(0,"mat-form-field",35)(1,"mat-label"),e._uU(2,"\u0627\u0644\u062e\u062f\u0645\u0627\u062a"),e.qZA(),e.TgZ(3,"mat-select",38),e.YNc(4,M,2,2,"mat-option",9),e.qZA()()),2&r){const i=e.oxw(3);e.xp6(4),e.Q6J("ngForOf",i.ServicesDataSource)}}function k(r,t){if(1&r&&(e.TgZ(0,"mat-form-field",35)(1,"mat-label"),e._uU(2,"\u0627\u0644\u062e\u062f\u0645\u0627\u062a"),e.qZA(),e._UZ(3,"input",39),e.qZA()),2&r){const i=e.oxw().index,o=e.oxw(2);e.xp6(3),e.Q6J("value",o.getServiceName(i))}}function j(r,t){if(1&r){const i=e.EpF();e.TgZ(0,"div",4),e.ynx(1,32),e.TgZ(2,"div",11),e.YNc(3,$,5,1,"mat-form-field",33),e.YNc(4,k,4,1,"ng-template",null,34,e.W1O),e.qZA(),e.TgZ(6,"div",14)(7,"mat-form-field",35)(8,"mat-label"),e._uU(9,"\u0627\u0644\u0633\u0639\u0631"),e.qZA(),e._UZ(10,"input",36),e.qZA()(),e.TgZ(11,"div",16)(12,"mat-form-field",35)(13,"mat-label"),e._uU(14,"\u0627\u0644\u0643\u0645\u064a\u0629"),e.qZA(),e._UZ(15,"input",17),e.qZA()(),e.TgZ(16,"div",18)(17,"button",37),e.NdJ("click",function(){const u=e.CHM(i).index,h=e.oxw(2);return e.KtG(h.handleDeleteNoteComponent(u))}),e.TgZ(18,"mat-icon"),e._uU(19,"delete"),e.qZA()()(),e.BQk(),e.qZA()}if(2&r){const i=t.$implicit,o=t.index,n=e.MAs(5);e.xp6(1),e.Q6J("formGroupName",o),e.xp6(2),e.Q6J("ngIf",!i.value.id)("ngIfElse",n)}}function B(r,t){if(1&r&&(e.TgZ(0,"div",30),e.YNc(1,j,20,3,"div",31),e.qZA()),2&r){const i=e.oxw();e.xp6(1),e.Q6J("ngForOf",i.noteComponents.controls)}}class d extends S.r{constructor(t,i,o,n,u,h,m,v,H,X){super(v,X,t,o),this._note=t,this.fb=i,this._client=n,this._clientType=u,this._service=h,this._servicePrice=m,this.data=H,this.clientTembId=null,this.TermsDataSource=[],this.StagesDataSource=[],this.ClientsDataSource=[],this.ClientTypesDataSource=[],this.ServicesDataSource=[],this.deletedComponents=[],this.getNoteComponentId=s=>this.noteComponents.at(s).get("id"),this.getNoteComponentServiceId=s=>this.noteComponents.at(s).get("serviceId"),this.servicePriceFormControl=s=>this.noteComponents.at(s).get("price"),this.serviceOriginalPriceFormControl=s=>this.noteComponents.at(s).get("originalPrice"),this.serviceQuantityFormControl=s=>this.noteComponents.at(s).get("quantity"),this.setClientTypeId=s=>this.clientTypeId.setValue(s),this.setClientId=s=>this.clientId.setValue(s),this.patchData=()=>{this.data.noteComponents.forEach(s=>{this.handleNewNoteComponent(),this._servicePrice.getPrice(this.data.clientTypeId,s.serviceId).subscribe({next:c=>{let p=this.data.noteComponents.indexOf(s);this.servicePriceFormControl(p).setValue(c.body.price),this.serviceOriginalPriceFormControl(p).setValue(c.body.originalPrice)},error:c=>{this.isSubmitting=!1,this.toastr.error((c.error??c).message)}})}),this.Form.patchValue(this.data),this.clientTembId=this.data.clientId},this.handleNewNoteComponent=()=>{let s=this.noteComponents.length;this.noteComponents.push(this.createFormItem("noteComponent")),this.subscribeQuantityChanges(s),this.subscribeServiceChanges(s)},this.handleDeleteNoteComponent=s=>{this.data&&this.deletedComponents.push(this.getNoteComponentId(s).value);let c=this.serviceQuantityFormControl(s).value;this.setOriginalAndActualPrices(-1,s,c),this.calculateFinalPriceAndEarning(),this.noteComponents.removeAt(s),this.noteComponents.length||(this.originalPrice.setValue(0),this.actualPrice.setValue(0),this.earning.setValue(0),this.finalPrice.setValue(0))},this.getServiceName=s=>this.ServicesDataSource.find(c=>c.id===this.getNoteComponentServiceId(s).value)?.name??"",this.Form=this.createFormItem("init")}get id(){return this.Form.get("id")}get noteId(){return this.Form.get("id")}get noteComponents(){return this.Form.get("noteComponents")}get clientTypeId(){return this.Form.get("clientTypeId")}get clientId(){return this.Form.get("clientId")}get originalPrice(){return this.Form.get("originalPrice")}get teacherPrice(){return this.Form.get("teacherPrice")}get actualPrice(){return this.Form.get("actualPrice")}get earning(){return this.Form.get("earning")}get finalPrice(){return this.Form.get("finalPrice")}ngOnInit(){this.forkJoins(),this.subscriptions.push(this.clientTypeId.valueChanges.pipe((0,C.O)(this.clientTypeId.value)).subscribe(t=>this.handleClientTypeChange(t))),this.subscriptions.push(this.teacherPrice.valueChanges.subscribe(t=>this.finalPrice.setValue(+this.actualPrice.value+ +t))),this.data&&this.patchData()}forkJoins(){let t=[this._note.getStages(),this._note.getTerms(),this._clientType.getAll(),this._service.GetAllPriced()];return(0,Z.D)(t).pipe((0,F.U)(([i,o,n,u])=>({stages:i,terms:o,clientsType:n,services:u}))).subscribe({next:i=>{this.TermsDataSource=i.terms.body,this.TermsDataSource.unshift({id:null,name:"\u0628\u062f\u0648\u0646"}),this.StagesDataSource=i.stages.body,this.StagesDataSource.unshift({id:null,name:"\u0628\u062f\u0648\u0646"}),this.ServicesDataSource=i.services.body,this.ClientTypesDataSource=i.clientsType.body},error:i=>{this.isSubmitting=!1,this.toastr.error((i.error??i).message)}})}createFormItem(t){let i=this.fb.group({});switch(t){case"init":i=this.fb.group({id:[0],name:["",[l.kI.required]],originalPrice:[0],earning:[0],actualPrice:[0],teacherPrice:[0,[l.kI.required,l.kI.min(0)]],finalPrice:[0],clientTypeId:[null],clientId:[null,[l.kI.required]],termId:[null],stageId:[null],noteComponents:this.fb.array([],l.kI.minLength(1)),quantity:[0]});break;case"noteComponent":i=this.fb.group({id:[0],noteId:[this.noteId.value],serviceId:[null,[l.kI.required]],quantity:[1,[l.kI.required,l.kI.min(1)]],price:[0],originalPrice:[0]})}return i}subscribeQuantityChanges(t){this.subscriptions.push(this.serviceQuantityFormControl(t).valueChanges.pipe((0,C.O)(this.serviceQuantityFormControl(t).value),function N(){return(0,A.e)((r,t)=>{let i,o=!1;r.subscribe((0,P.x)(t,n=>{const u=i;i=n,o&&t.next([u,n]),o=!0}))})}()).subscribe(([i,o])=>{this.setOriginalAndActualPrices(1,t,o-i),this.calculateFinalPriceAndEarning()}))}subscribeServiceChanges(t){this.subscriptions.push(this.getNoteComponentServiceId(t).valueChanges.subscribe(i=>{let o=this.serviceQuantityFormControl(t).value;this.subscriptions.push(this._servicePrice.getPrice(this.clientTypeId.value,i).subscribe({next:n=>{n.body?(this.setOriginalAndActualPrices(-1,t,o),this.serviceOriginalPriceFormControl(t).setValue(n.body.originalPrice),this.servicePriceFormControl(t).setValue(n.body.price),this.setOriginalAndActualPrices(1,t,o),this.calculateFinalPriceAndEarning()):this.toastr.error("\u0647\u0630\u0647 \u0627\u0644\u062e\u062f\u0645\u0629 \u063a\u064a\u0631 \u0645\u0633\u0639\u0631\u0629")},error:n=>{this.isSubmitting=!1,this.toastr.error((n.error??n).message)}}))}))}handleClientTypeChange(t){null!=t&&this.subscriptions.push(this._client.getAllByType(t).subscribe({next:i=>{this.ClientsDataSource=i.body},error:i=>{this.ClientsDataSource=[],this.clientId.reset(),this.isSubmitting=!1,this.toastr.error((i.error??i).message)},complete:()=>{this.clientTembId?(this.clientId.setValue(this.clientTembId),this.clientTembId=null):this.clientId.reset(),this.calculateNotePrice()}}))}setOriginalAndActualPrices(t,i,o){this.originalPrice.setValue(+this.originalPrice.value+t*(+this.serviceOriginalPriceFormControl(i).value*o)),this.actualPrice.setValue(+this.actualPrice.value+t*(+this.servicePriceFormControl(i).value*o))}calculateFinalPriceAndEarning(){this.earning.setValue(+this.actualPrice.value-+this.originalPrice.value),this.finalPrice.setValue(+this.actualPrice.value+ +this.teacherPrice.value)}calculateNotePrice(){var t=this;return(0,T.Z)(function*(){let i=0,o=0;if(!t.noteComponents.length)return t.originalPrice.setValue(0),t.actualPrice.setValue(0),t.earning.setValue(0),void t.finalPrice.setValue(0);for(let n=0;n<t.noteComponents.length;n++)if(t.getNoteComponentServiceId(n).value){let u=yield new Promise(h=>{t._servicePrice.getPrice(t.clientTypeId.value,t.getNoteComponentServiceId(n).value).subscribe({next:m=>h(m),error:m=>{t.isSubmitting=!1,t.toastr.error((m.error??m).message)}})});i+=u.body.price*t.serviceQuantityFormControl(n).value,o+=u.body.originalPrice*t.serviceQuantityFormControl(n).value,t.servicePriceFormControl(n).setValue(u.body.price),t.serviceOriginalPriceFormControl(n).setValue(u.body.originalPrice)}else t.servicePriceFormControl(n).setValue(0),t.serviceOriginalPriceFormControl(n).setValue(0);t.originalPrice.setValue(o),t.actualPrice.setValue(i),t.calculateFinalPriceAndEarning()})()}handleSubmit(){this.Form.valid&&(this.isSubmitting=!0,this.id.value?this.subscriptions.push(this._note.deleteNoteComponents(this.deletedComponents).subscribe({error:t=>{this.isSubmitting=!1,this.toastr.error((t.error??t).message)},complete:()=>this.update(this.data.id,this.Form.value)})):this.add(this.Form.value))}}d.\u0275fac=function(t){return new(t||d)(e.Y36(D.Y),e.Y36(l.qu),e.Y36(x._W),e.Y36(_.y),e.Y36(U.q),e.Y36(J.r),e.Y36(O.c),e.Y36(g.so),e.Y36(g.WI),e.Y36(q.sK))},d.\u0275cmp=e.Xpm({type:d,selectors:[["app-note-form-dialog"]],features:[e.qOj],decls:66,vars:17,consts:[[1,"container","w-100"],["class","w-100 text-center mt-3",4,"ngIf","ngIfElse"],["update",""],[1,"d-flex","flex-column",3,"formGroup","ngSubmit"],[1,"row"],["label","\u0646\u0648\u0639 \u0627\u0644\u0639\u0645\u064a\u0644",1,"col-3",3,"dataSource","selectedValue","selectedId"],["label","\u0623\u0633\u0645 \u0627\u0644\u0639\u0645\u064a\u0644",1,"col-3",3,"dataSource","selectedValue","selectedId"],["color","warn","appearance","fill",1,"col-3"],["formControlName","stageId"],[3,"value",4,"ngFor","ngForOf"],["formControlName","termId"],[1,"col-6"],["color","warn",1,"w-100"],["type","text","matInput","","formControlName","name"],[1,"col-3"],["type","number","min","0","matInput","","formControlName","teacherPrice"],[1,"col-2"],["type","number","min","0","matInput","","formControlName","quantity"],[1,"col-1"],["type","button","mat-icon-button","","matTooltip","add","color","basic","aria-label","add note component row",3,"disabled","click"],["formArrayName","noteComponents",4,"ngIf"],["type","number","matInput","","formControlName","actualPrice",3,"readonly"],["type","number","matInput","","formControlName","originalPrice",3,"readonly"],["type","number","matInput","","formControlName","earning",3,"readonly"],["type","number","matInput","","formControlName","finalPrice",3,"readonly"],[1,"my-2","d-flex","flex-row-reverse"],["mat-raised-button","","type","submit","color","warn",1,"mx-2","px-4",3,"disabled"],["type","button","mat-stroked-button","","color","warn","tabindex","-1",3,"click"],[1,"w-100","text-center","mt-3"],[3,"value"],["formArrayName","noteComponents"],["class","row",4,"ngFor","ngForOf"],[3,"formGroupName"],["color","warn","appearance","fill","class","w-100",4,"ngIf","ngIfElse"],["disabled",""],["color","warn","appearance","fill",1,"w-100"],["type","number","matInput","","formControlName","price","readonly","true"],["type","button","mat-icon-button","","matTooltip","delete","color","warn","aria-label","delete selected row",3,"click"],["formControlName","serviceId"],["type","text","matInput","","readonly","true",3,"value"]],template:function(t,i){if(1&t&&(e.TgZ(0,"div",0),e.YNc(1,G,2,0,"h2",1),e.YNc(2,W,2,0,"ng-template",null,2,e.W1O),e.TgZ(4,"mat-dialog-content")(5,"form",3),e.NdJ("ngSubmit",function(){return i.handleSubmit()}),e.TgZ(6,"div",4)(7,"autocomplete",5),e.NdJ("selectedId",function(n){return i.setClientTypeId(n)}),e.qZA(),e.TgZ(8,"autocomplete",6),e.NdJ("selectedId",function(n){return i.setClientId(n)}),e.qZA(),e.TgZ(9,"mat-form-field",7)(10,"mat-label"),e._uU(11,"\u0627\u0644\u0645\u0631\u062d\u0644\u0629"),e.qZA(),e.TgZ(12,"mat-select",8),e.YNc(13,K,2,2,"mat-option",9),e.qZA()(),e.TgZ(14,"mat-form-field",7)(15,"mat-label"),e._uU(16,"\u0627\u0644\u062a\u0631\u0645"),e.qZA(),e.TgZ(17,"mat-select",10),e.YNc(18,L,2,2,"mat-option",9),e.qZA()()(),e.TgZ(19,"div",4)(20,"div",11)(21,"mat-form-field",12)(22,"mat-label"),e._uU(23,"\u0623\u0633\u0645 \u0627\u0644\u0645\u0630\u0643\u0631\u0629"),e.qZA(),e._UZ(24,"input",13),e.qZA()(),e.TgZ(25,"div",14)(26,"mat-form-field",12)(27,"mat-label"),e._uU(28,"\u0647\u0627\u0645\u0634 \u0631\u0628\u062d \u0627\u0644\u0645\u062f\u0631\u0633"),e.qZA(),e._UZ(29,"input",15),e.qZA()(),e.TgZ(30,"div",16)(31,"mat-form-field",12)(32,"mat-label"),e._uU(33,"\u0627\u0644\u0643\u0645\u064a\u0629"),e.qZA(),e._UZ(34,"input",17),e.qZA()(),e.TgZ(35,"div",18)(36,"button",19),e.NdJ("click",function(){return i.handleNewNoteComponent()}),e.TgZ(37,"mat-icon"),e._uU(38,"add"),e.qZA()()()(),e.YNc(39,B,2,1,"div",20),e.TgZ(40,"div",4)(41,"div",14)(42,"mat-form-field",12)(43,"mat-label"),e._uU(44,"\u0627\u0644\u0633\u0639\u0631 \u0627\u0644\u0641\u0639\u0644\u064a"),e.qZA(),e._UZ(45,"input",21),e.qZA()(),e.TgZ(46,"div",14)(47,"mat-form-field",12)(48,"mat-label"),e._uU(49,"\u0627\u0644\u0633\u0639\u0631 \u0627\u0644\u062a\u0643\u0644\u0641\u0629"),e.qZA(),e._UZ(50,"input",22),e.qZA()(),e.TgZ(51,"div",14)(52,"mat-form-field",12)(53,"mat-label"),e._uU(54,"\u0647\u0627\u0645\u0634 \u0627\u0644\u0631\u0628\u062d"),e.qZA(),e._UZ(55,"input",23),e.qZA()(),e.TgZ(56,"div",14)(57,"mat-form-field",12)(58,"mat-label"),e._uU(59,"\u0627\u0644\u0633\u0639\u0631 \u0627\u0644\u0646\u0647\u0627\u0626\u064a"),e.qZA(),e._UZ(60,"input",24),e.qZA()()(),e.TgZ(61,"div",25)(62,"button",26),e._uU(63),e.qZA(),e.TgZ(64,"button",27),e.NdJ("click",function(){return i.onNoClick()}),e._uU(65,"\u0625\u0644\u063a\u0627\u0621"),e.qZA()()()()()),2&t){const o=e.MAs(3);e.xp6(1),e.Q6J("ngIf",i.id.value)("ngIfElse",o),e.xp6(4),e.Q6J("formGroup",i.Form),e.xp6(2),e.Q6J("dataSource",i.ClientTypesDataSource)("selectedValue",i.clientTypeId.value),e.xp6(1),e.Q6J("dataSource",i.ClientsDataSource)("selectedValue",i.clientId.value),e.xp6(5),e.Q6J("ngForOf",i.StagesDataSource),e.xp6(5),e.Q6J("ngForOf",i.TermsDataSource),e.xp6(18),e.Q6J("disabled",!i.clientId.value||i.clientId.invalid),e.xp6(3),e.Q6J("ngIf",i.noteComponents.controls.length),e.xp6(6),e.Q6J("readonly",!0),e.xp6(5),e.Q6J("readonly",!0),e.xp6(5),e.Q6J("readonly",!0),e.xp6(5),e.Q6J("readonly",!0),e.xp6(2),e.Q6J("disabled",!i.Form.valid||i.isSubmitting),e.xp6(1),e.Oqu(i.isSubmitting?"\u0627\u0646\u062a\u0638\u0631 \u0645\u0646 \u0641\u0636\u0644\u0643":"\u062d\u0641\u0638")}},dependencies:[l._Y,l.Fj,l.wV,l.JJ,l.JL,l.qQ,l.sg,l.u,l.x0,l.CE,b.sg,b.O5,Q.Y,g.xY,y.KE,y.hX,V.Hw,Y.Nt,E.gD,w.ey,I.lW,I.RK],styles:[".container[_ngcontent-%COMP%]{width:1000px}"]})}}]);